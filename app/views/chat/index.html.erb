<% title 'Discuss', @product.name %>
<% activate_nav! :product_discussions %>
<% provide :body_class, 'chat-wrapper' %>

<div class="navbar-fixed-top">
  <%= render 'shared/navbar' %>
  <%= render 'products/navbar' %>
</div>

<div class="container">
  <div class="row" style="position:relative">
    <div class="col-xs-8">
      <div class="chat js-chat">
        <center>
          <a class="btn btn-default btn-block js-chat-load-more" href="<%= product_chat_path(@product, format: 'json') %>">Load more</a>
          <br>
        </center>

        <div class="timeline chat-timeline js-activity-stream"></div>
        <div class="chat-actions js-chat-actions is-fixed" style="width:616px">
          <%= render 'discussions/chat_box' %>
        </div>
      </div>
    </div>

    <div class="col-xs-3" style="margin-top:136px;width:260px;position:fixed;margin-left:711px">
      <%#= render 'discussions/intro_panel' %>
      <div class="panel panel-default">
        <div class="panel-heading">
          <h6 class="panel-title">Members</h6>
        </div>
        <div class="js-members small"></div>
      </div>
      <a class="btn btn-default btn-block" href="<%= product_discussions_path(@product) %>">All Discussions</a>
    </div>
  </div>
</div>

<script>
  app.product = new Product(<%= ProductSerializer.new(@product, scope: current_user).to_json.html_safe %>);
  app.wip = new Wip(<%= WipSerializer.new(@product.main_thread, scope: current_user).to_json.html_safe %>);
</script>

<script>
  $(document).ready(function() {

    var activityStream = new ActivityStream(<%=
      @activity_stream.map {|a, _|
        ActivitySerializer.new(a, scope: current_user)
      }.to_json.html_safe
    %>);
    activityStream.url = '<%= product_wip_comments_path(@product, @product.main_thread) %>';
    activityStream.product = app.product;

    var activityStreamView = new ActivityStreamView({
      el: $('.js-activity-stream'),
      collection: activityStream
    });

    var members = new Members(<%= @watchers.map {|w| MemberSerializer.new(w) }.to_json.html_safe %>)

    window.members = members

    // Initialize pusher
    var pusher = new Pusher($('meta[name=pusher-key]').attr('content'), {
      authEndpoint: <%= webhooks_pusher_path.to_json.html_safe %>
    });

    pusher.connection.bind('connected', function() {
      activityStream.listenForRemote(pusher, pusher.connection);

      var presenceChannel = pusher.subscribe('presence-' + activityStream.channelName())

      presenceChannel.bind('pusher:subscription_succeeded', function(chan) {
        console.log('pusher members', chan.members)
      });

    });

    var chatView = new ChatView({
      el: $('.js-chat'),
      collection: activityStream
    });

    window.activityStream = activityStream;
    window.activityStreamView = activityStreamView;
    window.chatView = chatView;

    activityStreamView.render();
    chatView.render();

    $(window).load(function() {
      delay(1, chatView.scrollToLatestActivity);
    });

  });
</script>

<script>
  $(document).ready(function() {

    $('.js-members').each(function() {
      var component = React.renderComponent(
        MembersView({}),
        this
      )

      window.members.each(function(member) {
        component.addMember(member.attributes)
      })

      members.on('add', function(event, model, collection) {
        component.addMember(model.attributes)
      })
    })

  })
</script>

<!-- Analytics -->
<script>
  analytics.track('product.chat.viewed', <%== ProductSerializer.new(@product, scope: current_user).to_json %>)
</script>
