<div class="panel panel-default">
  <div class="panel-body text-small">
    <% case @wip.state %>
    <% when 'open' %>
      <div class="progress progress-small omega">
        <!-- <div class="progress-bar" style="width: 0%;"></div> -->
      </div>
      <h6 class="text-muted">
        Ready for work
      </h6>

      <p><strong>Think you'd be a great fit for this bounty?</strong> Jump in and help out.</p>
      <%= button_to 'Work on this bounty', product_wip_start_work_path(@wip.product, @wip), method: :patch, disable_with: 'Starting work…', class: %w(btn btn-default btn-sm btn-block) %>

      <% if signed_in? && @wip.product.core_team?(current_user) %>
        <div style="margin-top: 10px; margin-bottom: 0px;">
          <form role="form" class="form-inline" method="post" action="<%= product_wip_start_work_path(@wip.product, @wip) %>">
            <div style="display:none;">
              <input name="authenticity_token" type="hidden" value="<%= form_authenticity_token %>">
              <input name="_method" value="patch" type="hidden">
            </div>
            <div class="form-group">
              <label for="assign_to" class="sr-only">Username</label>
              <input id="assign_to"
                     class="form-control input-sm textcomplete"
                     data-product-id="<%= @product.slug %>"
                     type="text"
                     name="assign_to"
                     style="width: 100px; padding: 5px;"
                     placeholder="Username"
              >
            </div>
            <button type="submit" class="btn btn-default btn-sm" style="width: 55px; margin-top: 0px; padding-left: 6px;">Assign</button>
          </form>
        </div>
      <% end %>

    <% when 'allocated' %>
      <div class="progress progress-small omega">
        <div class="progress-bar progress-bar-success" style="width: 33%;"></div>
      </div>
      <h6 class="text-muted">
        In Progress
      </h6>
      <table class="table table-condensed">
        <tbody>
          <% @wip.wip_workers.each do |worker| %>
            <tr>
              <td class="omega">
              <% if signed_in? && worker.user == current_user %>
                  <a href="<%= user_path(worker.user) %>">You</a>
              <% else %>
                <a href="<%= user_path(worker.user) %>">
                  <strong>@<%= worker.user.username %></strong>
                </a>
              <% end %>
              started this
              <strong>
                <time class="timestamp" datetime="<%= worker.created_at.iso8601 %>"></time>
              </strong>
              </td>
              <% if signed_in? && @wip.product.core_team?(current_user) %>
                <td>
                  <% unless worker.user == current_user %>
                    <a title="remove" href="<%= product_wip_stop_work_path(@wip.product, @wip, user: worker.user.username) %>" data-method="patch" class="text-danger">
                      <span class="glyphicon glyphicon-remove"></span>
                    </a>
                  <% end %>
                </td>
              <% end %>
            <% end %>
          </tr>
        </tbody>
      </table>

      <% if signed_in? && @wip.workers.include?(current_user) %>
        <%= button_to 'Stop work', product_wip_stop_work_path(@wip.product, @wip), method: :patch, disable_with: 'Cancelling…', class: %w(btn btn-default btn-sm btn-block inactive) %>
      <% else %>
        <%= button_to 'Start work', product_wip_start_work_path(@wip.product, @wip), method: :patch, disable_with: 'Starting work…', class: %w(btn btn-default btn-sm btn-block) %>
      <% end %>

    <% when 'reviewing' %>
      <div class="progress progress-small omega">
        <div class="progress-bar progress-bar-success" style="width: 66%;"></div>
      </div>
      <h6 class="text-muted">
        Reviewing
      </h6>

      <!--
        This isn't perfect, there's no concept of the work that's up for
        review.
      -->
      <p class="omega">A submission is currently being reviewed by the Core Team.</p>

    <% when 'resolved' %>
      <div class="progress progress-small omega">
        <div class="progress-bar progress-bar-success" style="width: 100%;"></div>
      </div>
      <h6 class="text-muted">
        Complete
      </h6>
      <% if @wip.winner %>
        <% if signed_in? && @wip.winner == current_user %>
          <p>
            You were awarded
            <%= format_coins(@wip.product, @wip.bounty.total_cents) %>
            for completing this bounty.
          </p>
          <p class="omega"><strong>Keep up the great work!</strong></p>
        <% else %>
          <p class="omega">
            <strong><%= @wip.winner.username %></strong>
            was awarded
            <%= format_coins(@wip.product, @wip.bounty.total_cents) %>
            for completing this bounty.
          </p>
        <% end %>
      <% end %>
    <% end %>

    <% if signed_in? %>
      <div style="margin-top:15px" data-react-class="InviteFriendBounty" data-react-props='<%== {
          url: invites_path,
          invites: (@invites ? serialize_hash(@invites) : []),
        }.merge(TypeId.as_json(:via, @wip)).to_json %>'>
      </div>
    <% end %>
  </div>
</div>

<div class="panel panel-default">
  <div class="panel-heading">
    <h6 class="panel-title">
      <span class="pull-right"><%= @wip.watchers.count %></span>
      Watchers
    </h6>
  </div>
  <div class="panel-body">
    <ul class="list-grid omega">
      <% @wip.watchers.each do |user| %>
        <li>
          <a href="<%= user_path(user) %>">
            <%= avatar_tag(user, 21) %>
          </a>
        </li>
      <% end %>
    </ul>
  </div>
</div><!-- .panel -->

<div class="panel panel-default">
  <div class="panel-heading">
    <h6 class="panel-title">
      Tags
    </h6>
  </div>
  <div class="panel-body">
    <% wip_tags = @wip.tags.map { |tag| tag.name }.as_json %>
    <div style="margin-bottom: 10px"
         data-react-class="TagList"
         data-react-props="<%= {
            tags: (wip_tags || []),
            url: product_wip_path(@wip.product, @wip.number),
            filterUrl: product_wips_path(@wip.product),
            destination: true
          }.to_json %>">
    </div>
    <% unless current_user.nil? %>
      <% if wip_tags.empty? || wip_tags.slice(1).nil? %>
        <h6 style="margin-bottom: 0; margin-top: 20px;">Suggested tags</h6>
        <div data-react-class="TagList"
              data-react-props="<%= {
                tags: Wip::Tag.suggested_tags.as_json,
                url: product_wip_path(@wip.product, @wip.number),
                destination: false
              }.to_json %>">
        </div>
      <% end %>
      <div data-react-class="TextComplete"
           data-react-props="<%= {
             width: "125px",
             size: "small",
             label: "Add tag",
             prepend: "#",
             prompt: "Add",
             filterUrl: product_wips_path(@wip.product),
             url: product_wip_path(@wip.product, @wip.number)
           }.to_json %>">
      </div>
    <% end %>

  </div>
</div>

<div class="panel panel-default">
  <% b = @wip.bounty %>
  <div class="panel-heading">
    <a href="<%= product_contracts_path(@wip.product) %>" class="text-muted">
      <i class="icon-question pull-right" data-placement="top" data-toggle="tooltip" title="View&nbsp;all&nbsp;Tip&nbsp;Contracts"></i>
      </a>
    <h6 class="panel-title">
      Bounty Breakdown
    </h6>
  </div>
  <table class="table table-condensed small">
    <% if b.core_team_contracts.any? %>
      <tr>
        <td class="text-muted" style="padding-left:15px">
          Core Team tip
        </td>
        <td class="text-right" style="padding-right:15px">
          <%= format_coins @wip.product, b.core_team_contracts.map(&:amount).sum * b.total_cents, :tiny, round: true %>
        </td>
      </tr>
    <% end %>
    <% b.product_contracts.select{|c| c.amount * b.total_cents >= 100 }.each do |c| %>
      <tr>
        <td class="text-muted" style="padding-left:15px">
          @<%= c.user.username %> tip
        </td>
        <td class="text-right" style="padding-right:15px">
          <%= format_coins @wip.product, c.amount * b.total_cents, :tiny, round: true %>
        </td>
      </tr>
    <% end %>
  </table>
</div>
