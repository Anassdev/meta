<% title @user.username %>
<%= track_engaged 'user' %>
<%= render 'shared/navbar' %>

<div class="page page-flat">
  <div class="container">

    <div class="row">
      <div class="col-sm-3 col-xs-12">

        <%= render 'users/card', user: @user %>

        <% if can?(:update, @user) %>
          <a class="btn btn-default btn-block" href="<%= edit_user_path %>">
            Edit Profile
          </a>
          <br>
        <% end %>

        <% if Rails.env.development? || staff? %>
          <div class="well well-sm small">
            <div><%= @user.email %></div>
            <div>last request
              <%= time_ago_in_words(@user.last_request_at) %> ago</div>
            <div><%=link_to('Impersonate user', "/discover?auth_token=#{@user.authentication_token}")%></div>
            <div>
              <% if @user.flagged_at %>
                <a href="<%= unflag_user_path(@user) %>" data-method="patch">Unflag</a>
              <% else %>
                <a href="<%= flag_user_path(@user) %>" data-method="patch">Flag</a>
              <% end %>
            </div>
            <div>
              <% if @user.deleted_at %>
                Account removed <%= time_ago_in_words(@user.deleted_at) %> ago
              <% else %>
                <%= react_component 'ConfirmActionButton',
                              requireText: @user.username,
                              buttonLabel: 'Delete user account',
                              promptText: "This will delete everything! Type the user's username to confirm",
                              action: delete_account_user_path(@user) %>
              <% end %>
            </div>
          </div>
        <% end %>

      </div>

      <div class="col-sm-9 col-xs-12">
        <div class="page-header sheet-header">
          <%= render 'users/overview' %>
        </div>

        <% if @products.present? %>
          <h2>Core team member of these products</h2>
          <div class="list-group list-group-breakout">
            <% @products.each do |product| %>
              <a class="list-group-item" href="<%= product_path(product) %>">
                <%= render 'products/chips/greenlit', product: product %>
              </a>
            <% end %>
          </div>
        <% end %>

        <h2>Bounties</h2>
        <%= render 'bounties/filtered' %>

        <% if staff? %>
        <h2>Analytics</h2>
        <div class="row">
          <div class="col-md-12">
            <h3>Radar graph</h3>
            <div id="radar-graph">
              
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-12">
            <table>
              <thead>
                <tr>
                  <th>Tag</th>
                  <th>%</th>
                </tr>
              </thead>
              <tbody>
            <% @clusters.each do |p| %>
              <tr>
                <td><%= p[0] %></td>
                <td><%= (p[1]*100).round(0) %></td>
              </tr>
            <% end %>
            </tbody>
            </table>
          </div>
        </div>
        <div class="row">
          <div class="col-md-12">
            <h2>Leaderboard</h2>  
            <% (0..@cluster_names.count-1).each do |a| %>
              <h3><%= @cluster_names[a] %></h3>
              <table>
                <thead>
                  <tr>
                    <th>Rank</th>
                    <th>User</th>
                    <th>Rating</th>
                  </tr>
                </thead>
                <tbody>
                  <% g = 1 %>
                  <% @cluster_leaders[a].each do |username, score| %>
                    <tr>
                      <td><%= g %>
                      <td>
                        <a href= <%= user_path(User.find_by(username: username)) %>>
                        <%= username %>
                      </a>
                        </td>
                      <td><%= score.round(2) %></td>
                    </tr>
                    <% g = g + 1 %>
                  <% end %>
                </tbody>
              </table>
            <% end %>
          </div>
        </div>

        <% content_for :javascript do %>
          <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js" type="text/javascript"></script>
          <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.9/c3.min.js" type="text/javascript"></script>

          <script>
            $(document).ready(function() {
              var w = 500,
                h = 500;

              var colorscale = d3.scale.category10();

              //Legend titles
              var LegendOptions = ['Smartphone','Tablet'];

              //Data
              var data = <%= @radar_data.to_json.html_safe %>

              //Options for the Radar chart, other than default
              var mycfg = {
                w: w,
                h: h,
                maxValue: 0.6,
                levels: 6,
                ExtraWidthX: 300
              }

              //Call function to draw the Radar chart
              //Will expect that data is in %'s
              UserRadar.draw("#radar-graph", data, mycfg);

              ////////////////////////////////////////////
              /////////// Initiate legend ////////////////
              ////////////////////////////////////////////

              var svg = d3.select('#body')
                .selectAll('svg')
                .append('svg')
                .attr("width", w+300)
                .attr("height", h)

              //Create the title for the legend
              var text = svg.append("text")
                .attr("class", "title")
                .attr('transform', 'translate(90,0)') 
                .attr("x", w - 70)
                .attr("y", 10)
                .attr("font-size", "12px")
                .attr("fill", "#404040")
                .text("What % of owners use a specific service in a week");
                  
              //Initiate Legend 
              var legend = svg.append("g")
                .attr("class", "legend")
                .attr("height", 100)
                .attr("width", 200)
                .attr('transform', 'translate(90,20)') 
                ;
                //Create colour squares
                legend.selectAll('rect')
                  .data(LegendOptions)
                  .enter()
                  .append("rect")
                  .attr("x", w - 65)
                  .attr("y", function(d, i){ return i * 20;})
                  .attr("width", 10)
                  .attr("height", 10)
                  .style("fill", function(d, i){ return colorscale(i);})
                  ;
                //Create text next to squares
                legend.selectAll('text')
                  .data(LegendOptions)
                  .enter()
                  .append("text")
                  .attr("x", w - 52)
                  .attr("y", function(d, i){ return i * 20 + 9;})
                  .attr("font-size", "11px")
                  .attr("fill", "#737373")
                  .text(function(d) { return d; })
                  ; 

            })
          </script>
        <% end %>

        <% end %>

      </div>
    </div>
  </div>
</div>

<%= render 'shared/footer' %>
