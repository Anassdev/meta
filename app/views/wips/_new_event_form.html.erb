<% if !signed_in? %>
  <div class="educational-modal">
    <p><a class="btn btn-accent" href="<%= new_user_registration_path %>">Sign up</a> to join the discussion. Already have an account? <a href="<%= new_user_session_path %>">Sign in</a></p>
  </div>

<% else %>
  <div class="new-event js-new-event">

    <div class="avatar avatar-default">
      <% if signed_in? %>
        <img src="<%= current_user.avatar.url(46) %>" width="46" height="46">
      <% else %>
        <img src="<%= image_path('avatars/default.png') %>" width="46" height="46">
      <% end %>
    </div>

    <% if @wip.is_a?(Task) %>
      <div class="actions">
        <div class="work-type-caption comment">Discuss</div>
        <div class="work-type-caption work">Share work to earn <span class="bounty"><%= @wip.coins %></span></div>
        <ul class="nav nav-tabs">
          <li class="nav-item active discuss"><a href="#comment" data-toggle="tab">Comment</a></li>
          <li class="nav-item"><a href="#code" data-toggle="tab">Code</a></li>
          <li class="nav-item"><a href="#design" data-toggle="tab">Design</a></li>
          <li class="nav-item"><a href="#copy" data-toggle="tab">Copy</a></li>
        </ul>
      </div>
    <% end %>

    <!-- Tab panes -->
    <div class="tab-content">


      <!-- Comments -->

      <div class="tab-pane active" id="comment">
        <%= form_tag product_wip_comments_path(@wip.product, @wip), method: :post, class: %w(form new_event_comment) do %>

          <div class="form-control textdrop-control" id="new-comment-el">
            <%= text_area_tag 'event_comment[body]', nil, class: 'textarea-vertical textcomplete', placeholder: 'Add to the discussionâ€¦', data: { :autosize => '', 'product-id' => @product.slug } %>
            <div class="dropzone js-dropzone">
              <div class="dropzone-content">
                To attach files drag &amp; drop here or <a href="#">select files from your computer</a>...
              </div>
            </div>
          </div>

          <div class="form-actions">
            <%= button_tag 'Comment', name: 'event_comment[type]', value: 'Event::Comment', type: 'submit', class: %w(btn btn-primary) %>

            <% if can?(:update, @wip.product) %>
              <div class="btn-group pull-left">
                <% if @wip.resolved? %>
                  <%= button_tag 'Reopen', name: 'event_comment[type]', value: 'Event::Reopen', type: 'submit', class: %w(btn btn-default) %>
                <% else %>
                  <%= button_tag 'Close', name: 'event_comment[type]', value: 'Event::Close', type: 'submit', class: %w(btn btn-default) %>

                  <% if @wip.is_a?(Task) %>
                    <% if @wip.promoted? %>
                      <%= button_tag 'Demote', name: 'event_comment[type]', value: 'Event::Demote', type: 'submit', class: %w(btn btn-default) %>
                    <% else %>
                      <%= button_tag 'Promote', name: 'event_comment[type]', value: 'Event::Promote', type: 'submit', class: %w(btn btn-default) %>
                    <% end %>
                  <% end %>
                <% end %>
              </div>
            <% end %>

          </div>
        <% end %>
      </div>


      <!-- Code -->

      <div class="tab-pane" id="code">
        <%= form_tag product_wip_code_deliverables_path(@wip.product, @wip), method: :post, class: %w(form) do %>

          <div class="form-group" style="margin-bottom: 0;">
            <%= text_field_tag 'code_deliverable[url]', nil, class: 'form-control', placeholder: 'Pull Request URL' %>
          </div>

          <div class="form-actions">
            <%= submit_tag 'Add Pull Request', class: %w(btn btn-primary) %>
          </div>
        <% end %>
      </div>


      <!-- Design -->

      <div class="tab-pane" id="design">

        <div class="dropzone" id="design-deliverable-dropzone-el">
          <div class="dropzone-content">
            <div class="upload-state upload-state-ready">
              Drag &amp; drop design asset here or <a class="file-drop-select" href="#">select it from your computer</a>.
            </div>
            <div class="upload-state upload-state-uploading">
              Uploading...
            </div>
          </div>
        </div>

        <script>
          $(function(){
            new DesignDeliverableView({
              attachmentUploadUrl: '<%= "https://s3.amazonaws.com/#{ENV['ATTACHMENT_BUCKET']}" %>',
              el: $('#design-deliverable-dropzone-el'),
              wip_path: '<%= product_wip_path(@wip.product, @wip) %>'
            });
          });
        </script>


      </div>


      <!-- Copy -->

      <div class="tab-pane" id="copy">
        <%= form_tag product_wip_copy_deliverables_path(@wip.product, @wip), method: :post, class: 'form' do %>

          <div class="form-group" style="margin-bottom: 0;">
            <%= text_area_tag 'copy_deliverable[body]', nil, class: 'form-control form-type-copy' %>
          </div>


          <div class="form-actions">
            <%= submit_tag 'Add Copy', class: %w(btn btn-primary) %>
          </div>
        <% end %>
      </div>

    </div>

    <% if signed_in? && can?(:edit, @wip) %>
      <% if @wip.is_a?(Task) %>
        <%= button_to 'Make Discussion', product_task_to_discussion_path(@wip.product, @wip), method: :patch, class: 'btn btn-default' %>
      <% elsif @wip.is_a?(Discussion) %>
        <%= button_to 'Make Task', product_discussion_to_task_path(@wip.product, @wip), method: :patch, class: 'btn btn-default' %>
      <% end %>
    <% end %>

  </div>

  <script>
    new CommentView({
      attachmentUploadUrl: 'https://s3.amazonaws.com/<%= ENV['ATTACHMENT_BUCKET'] %>',
      el: $('#new-comment-el')
    });
  </script>
<% end %>
