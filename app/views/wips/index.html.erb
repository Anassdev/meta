<% title "Bounties", @product.name %>
<% activate_nav! :bounties %>

<% @show_urgency_dropdown = @product.core_team?(current_user) %>

<div class="page-header sheet-header">
  <div class="page-header-meta">
    <ul class="list-piped pull-right">
      <li>
        <div data-react-class="CreateBountyButton" data-react-props="<%= {
          product: { name: @product.name },
          url: product_wips_path(@product),
          maxOffer: (6 * @product.average_bounty).round(-4),
          averageBounty: @product.average_bounty
        }.to_json %>" style="position:relative;top:-8px"></div>
      </li>
    </ul>

    <ul class="list-piped">
      <li>
        <a class="<%= 'bg-primary' if params[:state] == '' %>" href="<%= scoped_product_bounties_path(@product, state: '') %>">
          <%= @product.tasks.open.count %>
          open
        </a>
      </li>

      <li>
        <a href="<%= scoped_product_bounties_path(@product, state: 'progress') %>">
          <%= @product.tasks.allocated.count %>
          in progress
        </a>
      </li>

      <li>
        <a href="<%= scoped_product_bounties_path(@product, state: 'closed') %>">
          <%= @product.tasks.closed.count %>
          closed
        </a>
      </li>

      <li>
        <a href="<%= scoped_product_bounties_path(@product, state: 'all') %>">All</a>
      </li>

      <li>
        Order:
        <select name="sort" id="bounty-sort">
          <option value="priority" <%= 'selected' if params[:sort] == 'priority' %>>Priority</option>
          <option value="most_valuable" <%= 'selected' if params[:sort] == 'most_valuable' %>>Most valuable</option>
          <option value="least_valuable" <%= 'selected' if params[:sort] == 'least_valuable' %>>Least valuable</option>
          <option value="newest" <%= 'selected' if params[:sort] == 'newest' %>>Newest</option>
          <option value="oldest" <%= 'selected' if params[:sort] == 'oldest' %>>Oldest</option>
          <option value="recently_updated" <%= 'selected' if params[:sort] == 'recently_updated' %>>Recently updated</option>
          <option value="least_recently_updated" <%= 'selected' if params[:sort] == 'least_recently_updated' %>>Least recently updated</option>
        </select>

        <script>
          // bless stack overflow http://stackoverflow.com/a/10997390/11236

          function updateURLParameter(url, param, paramVal){
            var newAdditionalURL = "";
            var tempArray = url.split("?");
            var baseURL = tempArray[0];
            var additionalURL = tempArray[1];
            var temp = "";
            if (additionalURL) {
              tempArray = additionalURL.split("&");
              for (i=0; i<tempArray.length; i++){
                if(tempArray[i].split('=')[0] != param){
                  newAdditionalURL += temp + tempArray[i];
                  temp = "&";
                }
              }
            }

            var rows_txt = temp + "" + param + "=" + paramVal;
            return baseURL + "?" + newAdditionalURL + rows_txt;
          }

          $('#bounty-sort').change(function() {
            var sortOrder = $(this).val();
            var newUrl = updateURLParameter(window.location.href, 'sort', sortOrder);
            window.location = newUrl;
          })
        </script>
      </li>
    </ul>
  </div>
</div>

<div class="sheet-body">
  <% if @project %>
    <%= render 'projects/header', project: @project %>
  <% end %>

  <div class="row">
    <% if @product.wips.count > 1 %>
      <div class="col-md-9">

        <% if @project %>
          <div class="markdown-normalized" style="margin-bottom: 40px">
            <%== product_markdown(@project.product, @project.description) %>
          </div>
        <% end %>

        <ol class="list-group list-group-breakout list-group-padded" id="wips-view-el">
          <% @wips.each do |task| %>
            <li class="list-group-item">
              <%= render 'bounties/chip', bounty: task %>
            </li>
          <% end %>
        </ol>

        <hr>

        <%= paginate @wips, theme: 'twitter-bootstrap-3' %>
      </div>

      <div class="col-md-3">
        <%= render 'bounties/projects_filter', projects: @milestones %>
      </div>

    <% else %>
      <div class="col-md-6 col-md-offset-3">
        <div class="well well-lg omega">
          <h3 class="alpha"><strong>Create the first task</strong></h3>
          <p class="text-muted omega">
            Get started by breaking down a new idea into bite-sized chunks
            that can valued and prioritized. Writing a great description will
            make it super easy for anyone to jump in and get to work.
          </p>
        </div>
      </div>
    <% end %>
  </div><!-- .row -->

  <% unless staff? %>
    <script>
      analytics.track('product.wips.viewed', <%== ProductAnalyticsSerializer.new(@product).to_json %>)
    </script>
  <% end %>
</div>
